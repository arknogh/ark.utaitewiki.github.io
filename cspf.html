<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Song Template Converter</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
  <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
    <div class="px-6 py-4 bg-indigo-600">
      <h1 class="text-2xl font-bold text-white">Song Template Converter</h1>
      <p class="text-indigo-100">Convert old Song templates to the new Utattemita format</p>
    </div>
    
    <div class="p-6">
      <div class="mb-6">
        <label for="oldTemplate" class="block text-sm font-medium text-gray-700 mb-1">Old Template Format</label>
        <textarea id="oldTemplate" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm" placeholder="Paste the old Song template here..."></textarea>
      </div>
      
      <div class="flex justify-center mb-6">
        <button id="convertButton" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
          Convert Template
        </button>
      </div>
      
      <div class="mb-4">
        <label for="newTemplate" class="block text-sm font-medium text-gray-700 mb-1">New Template Format</label>
        <textarea id="newTemplate" rows="20" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm" readonly></textarea>
      </div>
      
      <div class="flex justify-end">
        <button id="copyButton" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
          Copy to Clipboard
        </button>
      </div>
    </div>
    
    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
      <h2 class="text-lg font-medium text-gray-900 mb-2">Instructions</h2>
      <ol class="list-decimal list-inside text-gray-700 space-y-1 text-sm">
        <li>Paste your old Song template format in the top box</li>
        <li>Click "Convert Template" to transform it</li>
        <li>The new Utattemita format will appear in the bottom box</li>
        <li>Click "Copy to Clipboard" to copy the result</li>
      </ol>
    </div>
  </div>

  <script>
    /**
     * Converts an old Song template transclusion format to the new Utattemita format.
     * 
     * Requirements:
     * 1. NND, YT, and BB fields always exist in output even if empty in input
     * 2. Producer field is copied as-is, just renamed to Producers
     * 3. Preserves case sensitivity for MediaWiki compatibility
     * 
     * @param {string} oldTemplate - The old Song template transclusion
     * @return {string} The new template format
     */
    function convertSongTemplate(oldTemplate) {
  // We'll use a state machine approach to parse the template
  const fields = {
    image: '',
    songtitle: '',
    nnd: '',
    yt: '',
    bb: '',
    main: '',
    producer: ''
  };
  
  // Normalize line endings
  const normalizedTemplate = oldTemplate.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  
  // Tokenize the template, respecting nested templates
  let tokens = [];
  let currentToken = '';
  let nestedLevel = 0;
  
  for (let i = 0; i < normalizedTemplate.length; i++) {
    const char = normalizedTemplate[i];
    const nextChar = normalizedTemplate[i + 1] || '';
    
    // Handle opening of templates
    if (char === '{' && nextChar === '{') {
      currentToken += '{{';
      nestedLevel++;
      i++; // Skip the next character
    } 
    // Handle closing of templates
    else if (char === '}' && nextChar === '}') {
      currentToken += '}}';
      nestedLevel--;
      i++; // Skip the next character
    } 
    // Only treat pipes as field separators if not in a nested template
    else if (char === '|' && nestedLevel <= 1) {
      if (currentToken.trim()) {
        tokens.push(currentToken.trim());
      }
      currentToken = '';
    } 
    else {
      currentToken += char;
    }
  }
  
  // Add the final token
  if (currentToken.trim()) {
    tokens.push(currentToken.trim());
  }
  
  // Process tokens into fields
  for (const token of tokens) {
    // Skip the template name token
    if (token.startsWith('{{Song')) continue;
    if (token === '}}') continue;
    
    // Extract field name and value
    const equalPos = token.indexOf('=');
    if (equalPos === -1) continue;
    
    const fieldName = token.substring(0, equalPos).trim().toLowerCase();
    const fieldValue = token.substring(equalPos + 1).trim();
    
    // Assign to our fields object
    if (fieldName in fields) {
      fields[fieldName] = fieldValue;
    }
  }
  
  // Remove hyphens from main field
  fields.main = fields.main.replace(/^-/, '').replace(/-$/, '').trim();
  
  // Generate the new template
  return `{{Coverlist}}{{TabberType2|
      tab1=Main|content1=
      {{#tag:tabber|
      Song Information=
      {{Utattemita
      |Title=${fields.songtitle}
      |NND=${fields.nnd}
      |YT=${fields.yt}
      |BB=${fields.bb}
      |Image=${fields.image}
      |Vocal=${fields.main}
      |Producers=${fields.producer}
      }}
      {{!}}-{{!}}
      {{#ifexist: {{PAGENAME}}/Lyrics | {{!}}-{{!}}Lyrics= {{/Lyrics}}}}}}|tab2=Cover List|content2={{TabberType2
      |hide1={{#ifexist: {{PAGENAME}}/Male Utaite|false|true}}|tab1=Male Utaite|content1={{/Male Utaite}}
      |hide2={{#ifexist: {{PAGENAME}}/Male Utaite Groups|false|true}}|tab2=Male Utaite Groups|content2={{/Male Utaite Groups}}
      |hide3={{#ifexist: {{PAGENAME}}/Female Utaite|false|true}}|tab3=Female Utaite|content3={{/Female Utaite}}
      |hide4={{#ifexist: {{PAGENAME}}/Female Utaite Groups|false|true}}|tab4=Female Utaite Groups|content4={{/Female Utaite Groups}}
      |hide5={{#ifexist: {{PAGENAME}}/Androgynous Utaite|false|true}}|tab5=Androgynous Utaite|content5={{/Androgynous Utaite}}
      |hide6={{#ifexist: {{PAGENAME}}/Male Youtaite|false|true}}|tab6=Male Youtaite|content6={{/Male Youtaite}}
      |hide7={{#ifexist: {{PAGENAME}}/Male Youtaite Groups|false|true}}|tab7=Male Youtaite Groups|content7={{/Male Youtaite Groups}}
      |hide8={{#ifexist: {{PAGENAME}}/Female Youtaite|false|true}}|tab8=Female Youtaite|content8={{/Female Youtaite}}
      |hide9={{#ifexist: {{PAGENAME}}/Female Youtaite Groups|false|true}}|tab9=Female Youtaite Groups|content9={{/Female Youtaite Groups}}
      |hide10={{#ifexist: {{PAGENAME}}/Androgynous Youtaite|false|true}}|tab10=Androgynous Youtaite|content10={{/Androgynous Youtaite}}
      |hide11={{#ifexist: {{PAGENAME}}/Male Virtual Youtuber|false|true}}|tab11=Male Virtual Youtuber|content11={{/Male Virtual Youtuber}}
      |hide12={{#ifexist: {{PAGENAME}}/Female Virtual Youtuber|false|true}}|tab12=Female Virtual Youtuber|content12={{/Female Virtual Youtuber}}
      |hide13={{#ifexist: {{PAGENAME}}/Androgynous Virtual Youtuber|false|true}}|tab13=Androgynous Virtual Youtuber|content13={{/Androgynous Virtual Youtuber}}
      |hide14={{#ifexist: {{PAGENAME}}/Units|false|true}}|tab14=Units|content14={{/Units}}
      }}}}`;
    }

    // Add event listeners when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      const oldTemplateTextarea = document.getElementById('oldTemplate');
      const newTemplateTextarea = document.getElementById('newTemplate');
      const convertButton = document.getElementById('convertButton');
      const copyButton = document.getElementById('copyButton');

      // Example template for easy testing
      const exampleTemplate = `{{Song
|image = CHIKYUU.png
|songtitle =  Chikyuu Saigo no Kokuhaku wo<br>(地球最後の告白を)<br>(The Earth's Last Confession)
|nnd = sm18198019|yt =|bb=
|main = -{{VW|GUMI}}-
|producer = Music & Lyrics: {{VW|kemu}}<br>Illustration: [[Avatar Illustrators#H|hatsuko]]<br>Movie: [http://www.nicovideo.jp/mylist/14639164 ke-sanβ]<br>SMC: [http://www.nicovideo.jp/mylist/20737161 Suzumu]
}}`;

      // Pre-fill with example for testing (optional)
      oldTemplateTextarea.value = exampleTemplate;
      
      // Convert button functionality
      convertButton.addEventListener('click', function() {
        const oldTemplate = oldTemplateTextarea.value;
        if (oldTemplate.trim() === '') {
          alert('Please enter an old template format first.');
          return;
        }
        
        try {
          const newTemplate = convertSongTemplate(oldTemplate);
          newTemplateTextarea.value = newTemplate;
        } catch (error) {
          console.error('Conversion error:', error);
          alert('Error during conversion. Please check the console for details.');
        }
      });
      
      // Copy button functionality
      copyButton.addEventListener('click', function() {
        newTemplateTextarea.select();
        
        try {
          document.execCommand('copy');
          const originalText = copyButton.textContent;
          copyButton.textContent = 'Copied!';
          
          setTimeout(function() {
            copyButton.textContent = originalText;
          }, 2000);
        } catch (error) {
          console.error('Copy error:', error);
          alert('Failed to copy to clipboard. Please select and copy manually.');
        }
      });
    });
  </script>
</body>
</html>
