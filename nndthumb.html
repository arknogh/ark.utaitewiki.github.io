<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niconico Thumbnail Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100px);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Auth Form -->
        <div id="authForm" class="max-w-md mx-auto mb-8">
            <h1 class="text-3xl font-bold text-center mb-8">Authentication Required</h1>
            <form id="passwordForm" class="flex flex-col gap-4">
                <input 
                    type="password" 
                    id="passwordInput" 
                    placeholder="Enter password" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                >
                <button 
                    type="submit" 
                    class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    Login
                </button>
            </form>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <span id="toastMessage">Invalid password</span>
        </div>
        <!-- Main Content (hidden until authenticated) -->
        <div id="mainContent" class="hidden">
            <h1 class="text-3xl font-bold text-center mb-8">Niconico Thumbnail Downloader</h1>
            
            <!-- Search Form -->
            <div class="max-w-2xl mx-auto mb-8">
                <form id="searchForm" class="flex flex-col gap-4">
                    <input 
                        type="text" 
                        id="searchInput" 
                        name="n"
                        placeholder="Enter video ID (sm12345) or URL (https://nicovideo.jp/watch/sm12345)" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    >
                    <button 
                        type="submit" 
                        class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        Get Thumbnail
                    </button>
                </form>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden">
                <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </div>

            <!-- Result Card -->
            <div id="result" class="hidden max-w-2xl mx-auto">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div id="thumbnailContainer" class="relative pb-[56.25%]">
                        <!-- Thumbnail will be inserted here -->
                    </div>
                    <div class="p-4">
                        <h3 id="videoTitle" class="text-lg font-medium mb-4"></h3>
                        <button 
                            id="downloadButton"
                            class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                            Download Thumbnail
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error" class="hidden max-w-2xl mx-auto mt-4">
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>
    <script>
        const HEADER_NAME = "X-API-Key"; // Default header name
        let currentThumbnailUrl = '';
        let currentVideoId = '';
        let apiKey = '';
        // Hardcoded auth token hash for demo purposes
        // In a real application, this would be stored on a server
        const AUTH_TOKEN = "a8a0cb7e032390db54e21686ca3d527ab66c36a8861b084bb1949191ab34dd86"; // SHA-256 hash of "password"

        function hashPassword(password) {
            // In a production environment, use a proper crypto library
            // This function simulates the server-side hash_password function
            return sha256(password);
        }

        // Simple SHA-256 implementation
        async function sha256(message) {
            // Use the browser's crypto API
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Extract video ID from URL or ID string
        function extractVideoId(input) {
            const urlMatch = input.match(/nicovideo\.jp\/watch\/((sm|nm|so)\d+)/);
            if (urlMatch) {
                return urlMatch[1];
            }
            
            const idMatch = input.match(/^(sm|nm|so)\d+$/);
            if (idMatch) {
                return input;
            }
            
            throw new Error("Invalid video ID or URL format");
        }

        // Fetch video info from Niconico
        async function fetchVideoInfo(videoId) {
            try {
                // Use a CORS proxy to access Niconico API
                // Note: In a real application, you'd use your server as a proxy
                const proxyUrl = `https://corsproxy.io/?`;
                const url = `${proxyUrl}https://www.nicovideo.jp/watch/${videoId}?responseType=json`;
                
                const response = await fetch(url, {
                    headers: {
                        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
                    }
                });
                
                if (!response.ok) {
                    throw new Error("Failed to fetch video info");
                }
                
                const data = await response.json();
                
                if ("data" in data && "metadata" in data["data"]) {
                    const metadata = data["data"]["metadata"];
                    
                    let thumbnailUrl = null;
                    let title = null;
                    
                    for (const meta of metadata.metaTags || []) {
                        if (meta.property === "og:image") {
                            thumbnailUrl = meta.content;
                        } else if (meta.property === "og:title") {
                            title = meta.content;
                        }
                    }
                    
                    if (!thumbnailUrl || !title) {
                        throw new Error("Thumbnail or title not found");
                    }
                    
                    return {
                        url: {
                            url: thumbnailUrl,
                            title: title
                        },
                        code: 1
                    };
                } else {
                    throw new Error("Video data not found");
                }
            } catch (error) {
                console.error("Error fetching video info:", error);
                throw error;
            }
        }

        // Handle password submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('passwordInput').value;
            
            try {
                const hashedPassword = await hashPassword(password);
                
                if (hashedPassword === AUTH_TOKEN) {
                    apiKey = password;
                    toggleElement('authForm', false);
                    toggleElement('mainContent', true);
                } else {
                    showToast('Invalid password');
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            } catch (error) {
                console.error('Authentication failed:', error);
                showError('Authentication failed');
            }
        });

        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const input = document.getElementById('searchInput').value.trim();
            if (!input) return;

            // Reset UI
            toggleElement('loading', true);
            toggleElement('result', false);
            toggleElement('error', false);

            try {
                const videoId = extractVideoId(input);
                
                // Fetch video info
                const data = await fetchVideoInfo(videoId);
                
                if (data.code === 1 && data.url) {
                    // Update current thumbnail URL and video ID
                    currentThumbnailUrl = data.url.url;
                    currentVideoId = videoId;

                    // Update UI
                    const thumbnailContainer = document.getElementById('thumbnailContainer');
                    thumbnailContainer.innerHTML = `
                        <img 
                            src="${data.url.url}" 
                            alt="${data.url.title}"
                            class="absolute top-0 left-0 w-full h-full object-cover"
                        >
                    `;
                    
                    document.getElementById('videoTitle').textContent = data.url.title;
                    toggleElement('result', true);
                } else {
                    showError('Invalid response from server');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to fetch thumbnail info: ' + error.message);
            } finally {
                toggleElement('loading', false);
            }
        });

        // Helper function to show/hide elements
        function toggleElement(id, show) {
            document.getElementById(id).classList.toggle('hidden', !show);
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            toggleElement('error', true);
        }

        // Handle download button click
        document.getElementById('downloadButton').addEventListener('click', async () => {
            if (currentThumbnailUrl) {
                try {
                    // Fetch the image directly
                    const response = await fetch(currentThumbnailUrl);
                    if (!response.ok) throw new Error('Failed to download image');
                    
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = `${currentVideoId}_thumbnail.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(blobUrl);
                } catch (error) {
                    console.error('Download failed:', error);
                    showError('Failed to download thumbnail. CORS policy may be blocking the download.');
                }
            }
        });

        // For demo purposes, automatically bypass authentication
        // Remove this in a real application
        window.addEventListener('load', () => {
            // Uncomment this line to bypass authentication for testing
            // document.getElementById('passwordForm').dispatchEvent(new Event('submit'));
        });
    </script>
</body>
</html>
