<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-gray-800">Template Converter</h1>
            <p class="text-center text-gray-600 mt-2">Convert old format templates to the new format</p>
        </header>
        
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="p-4 bg-blue-50 border-b border-blue-100">
                <h2 class="text-lg font-medium text-blue-800">How to use</h2>
            </div>
            <div class="p-4 text-gray-700">
                <ol class="list-decimal pl-5 space-y-2">
                    <li>Paste your old format template in the left box</li>
                    <li>Click "Convert Template" to generate the new format</li>
                    <li>Copy the result from the right box</li>
                </ol>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <label for="input" class="block text-sm font-medium text-gray-700 mb-2">Old Format:</label>
                <textarea id="input" placeholder="Paste old format here..." class="w-full h-80 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm font-mono"></textarea>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between mb-2">
                    <label for="output" class="block text-sm font-medium text-gray-700">New Format:</label>
                    <button onclick="copyOutput()" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors" id="copyBtn">
                        Copy
                    </button>
                </div>
                <textarea id="output" readonly placeholder="Converted template will appear here..." class="w-full h-80 p-3 border border-gray-300 rounded-md bg-gray-50 text-sm font-mono"></textarea>
            </div>
        </div>
        
        <div class="mt-6 flex justify-center">
            <button onclick="convert()" id="convertBtn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                Convert Template
            </button>
        </div>
        
        <div id="errorMessage" class="mt-4 bg-red-50 text-red-700 p-3 rounded-md hidden"></div>
        
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>Template conversion tool for song cover entries</p>
        </footer>
    </div>

    <script>
        function formatExternalLink(type, id) {
            switch(type) {
                case 'sc':
                    return `[https://w.soundcloud.com/player/?url=https://api.soundcloud.com/tracks/${id} Soundcloud]`;
                case 'bb':
                    // BB now handled separately as a parameter
                case 'koe':
                    return `{{Koebu|${id}}}`;
                case 'tm':
                    return `[http://tmbox.net/pl/${id} TmBox]`;
                case 'box':
                    return `[https://www.box.com/s/${id} box]`;
                default:
                    return '';
            }
        }

        function parseOldFormat(text) {
            const blocks = text.split('{{Song covers').filter(block => block.trim());
            const entries = [];
            
            blocks.forEach(block => {
                for (let i = 1; i <= 5; i++) {
                    const entry = {};
                    
                    // Extract singer
                    const singerMatch = block.match(new RegExp(`singer${i} = ([^\\n|]+)`));
                    if (!singerMatch) continue;
                    
                    let singer = singerMatch[1].trim();
                    let description = '';
                    
                    // Handle <br> content
                    if (singer.includes('<br>')) {
                        const [baseSinger, brContent] = singer.split('<br>');
                        singer = baseSinger.trim();
                        description = brContent.trim();
                    }
                    
                    // Handle parenthetical content
                    if (singer.includes('(')) {
                        const [baseSinger, parentContent] = singer.split('(');
                        singer = baseSinger.trim();
                        description = (description + ' ' + parentContent.replace(')', '')).trim();
                    }
                    
                    // Handle CD and various platform links
                    const cdMatch = block.match(new RegExp(`cd${i} = ([^\\n|]+)`));
                    const tmMatch = block.match(new RegExp(`tm${i} = ([^\\n|]+)`));
                    const scMatch = block.match(new RegExp(`sc${i} = ([^\\n|]+)`));
                    const bbMatch = block.match(new RegExp(`bb${i} = ([^\\n|]+)`));
                    const koebuMatch = block.match(new RegExp(`koe${i} = ([^\\n|]+)`));
                    const boxMatch = block.match(new RegExp(`box${i} = ([^\\n|]+)`));
                    
                    if (cdMatch) {
                        const [_, albumName] = cdMatch[1].split('#');
                        singer = singer + '#' + albumName.trim();
                    }
                    
                    // Add platform links to description (except BB)
                    const links = [];
                    if (scMatch && scMatch[1].trim()) {
                        links.push(formatExternalLink('sc', scMatch[1].trim()));
                    }
                    // Handle BB separately now
                    if (bbMatch && bbMatch[1].trim()) {
                        entry.BB = bbMatch[1].trim();
                    }
                    if (koebuMatch && koebuMatch[1].trim()) {
                        links.push(formatExternalLink('koe', koebuMatch[1].trim()));
                    }
                    if (tmMatch && tmMatch[1].trim()) {
                        links.push(formatExternalLink('tm', tmMatch[1].trim()));
                    }
                    if (boxMatch && boxMatch[1].trim()) {
                        links.push(formatExternalLink('box', boxMatch[1].trim()));
                    }
                    
                    if (links.length > 0) {
                        description = description ? `${description} ${links.join(' ')}` : links.join(' ');
                    }
                    
                    // Check if it's a multi-singer entry
                    const hasMultipleSingers = singer.includes(' x ');
                    if (hasMultipleSingers) {
                        // Use customlink=true instead of singernolink=y
                        entry.customlink = 'true';
                    }
                    
                    // Remove [[ ]] if not multi-singer
                    if (!hasMultipleSingers) {
                        singer = singer.replace(/\[\[|\]\]/g, '');
                    }
                    
                    entry.singer = singer;
                    if (description) entry.description = description;
                    
                    // Extract YT and NND
                    const ytMatch = block.match(new RegExp(`yt${i} = ([^\\n|]*)`));
                    const nndMatch = block.match(new RegExp(`nnd${i} = ([^\\n|]*)`));
                    
                    if (ytMatch && ytMatch[1].trim()) entry.YT = ytMatch[1].trim();
                    if (nndMatch && nndMatch[1].trim()) entry.NND = nndMatch[1].trim();
                    
                    // Add placeholder image
                    entry.image = 'imagename.png';
                    
                    if (Object.keys(entry).length > 1) {
                        entries.push(entry);
                    }
                }
            });
            
            return entries;
        }

        function formatNewTemplate(entries) {
            let output = '{{NOUT\n|entries=';
            entries.forEach(entry => {
                output += '{{NUTE\n';
                Object.entries(entry).forEach(([key, value]) => {
                    output += `|${key}=${value}\n`;
                });
                output += '}}';
            });
            output += '}}';
            return output;
        }

        function convert() {
            const input = document.getElementById('input');
            const output = document.getElementById('output');
            const errorMessage = document.getElementById('errorMessage');
            const convertBtn = document.getElementById('convertBtn');
            
            // Hide any previous error
            errorMessage.classList.add('hidden');
            
            // Disable button and show loading state
            convertBtn.disabled = true;
            convertBtn.innerText = 'Converting...';
            convertBtn.classList.add('bg-blue-400');
            convertBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            setTimeout(() => {
                try {
                    if (!input.value.trim()) {
                        throw new Error('Please paste old format template first');
                    }
                    
                    const entries = parseOldFormat(input.value);
                    
                    if (entries.length === 0) {
                        throw new Error('No valid entries found in the input');
                    }
                    
                    output.value = formatNewTemplate(entries);
                    
                    // Flash success indicator
                    output.classList.add('bg-green-50', 'border-green-200');
                    setTimeout(() => {
                        output.classList.remove('bg-green-50', 'border-green-200');
                    }, 1000);
                    
                } catch (error) {
                    output.value = '';
                    errorMessage.textContent = 'Error: ' + error.message;
                    errorMessage.classList.remove('hidden');
                } finally {
                    // Restore button state
                    convertBtn.disabled = false;
                    convertBtn.innerText = 'Convert Template';
                    convertBtn.classList.remove('bg-blue-400');
                    convertBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            }, 300); // Small delay to show loading state
        }
        
        function copyOutput() {
            const output = document.getElementById('output');
            const copyBtn = document.getElementById('copyBtn');
            
            if (!output.value) return;
            
            output.select();
            document.execCommand('copy');
            
            // Change button text temporarily
            const originalText = copyBtn.innerText;
            copyBtn.innerText = 'Copied!';
            copyBtn.classList.add('bg-green-100', 'text-green-700');
            
            setTimeout(() => {
                copyBtn.innerText = originalText;
                copyBtn.classList.remove('bg-green-100', 'text-green-700');
            }, 1500);
        }
    </script>
</body>
</html>
