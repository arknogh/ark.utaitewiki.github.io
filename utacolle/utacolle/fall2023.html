<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utacolle Rankings</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/jquery.dataTables.min.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Utacolle Rankings</h1>
            <div class="space-x-2">
                <button onclick="openAddModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Add New Entry
                </button>
                <button onclick="exportData()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Export Data
                </button>
                <button onclick="openImportModal()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Import Data
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="mb-4">
                <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4">
                    <p class="font-bold">Important Notice:</p>
                    <p>Please remember to regularly export and save your data to a .txt file. Browser storage can be cleared unexpectedly, which would result in data loss. Use the Export button above to save your work!</p>
                </div>
                <textarea id="outputText" class="w-full h-32 p-2 border rounded" readonly></textarea>
                <button onclick="copyOutput()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Copy Output
                </button>
            </div>

            <table id="rankingsTable" class="w-full">
                <thead>
                    <tr>
                        <th>Ranking</th>
                        <th>Song Title</th>
                        <th>Utaite</th>
                        <th>Video Link</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="entryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-full max-w-md">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Add New Entry</h2>
            <input type="hidden" id="editId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ranking</label>
                    <input type="number" id="rankingInput" class="mt-1 w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Song Title</label>
                    <input type="text" id="songTitleInput" class="mt-1 w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Utaite Wiki Link</label>
                    <input type="text" id="utaiteWikiInput" class="mt-1 w-full border rounded p-2" placeholder="e.g., Tsukimiguu">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Utaite Display Name</label>
                    <input type="text" id="utaiteDisplayInput" class="mt-1 w-full border rounded p-2" placeholder="e.g., つきみぐー、">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Video ID</label>
                    <input type="text" id="videoIdInput" class="mt-1 w-full border rounded p-2" placeholder="e.g., sm44324666">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Cancel
                </button>
                <button onclick="saveEntry()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Import Data</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Paste your exported data here:</label>
                    <textarea id="importData" class="mt-1 w-full h-48 border rounded p-2"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeImportModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Cancel
                </button>
                <button onclick="importData()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Confirm Delete</h2>
            <p>Are you sure you want to delete this entry?</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeDeleteModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        let rankings = [];
        let table;
        let deleteId = null;

        $(document).ready(function() {
            table = $('#rankingsTable').DataTable({
                columns: [
                    { data: 'ranking' },
                    { data: 'songTitle' },
                    { 
                        data: 'utaite',
                        render: function(data, type, row) {
                            return row.utaiteDisplay ? 
                                `[[${row.utaiteWiki}|${row.utaiteDisplay}]]` : 
                                `[[${row.utaiteWiki}]]`;
                        }
                    },
                    { data: 'videoId' },
                    {
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <button onclick="openEditModal(${row.ranking})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                <button onclick="openDeleteModal(${row.ranking})" class="text-red-600 hover:text-red-800">Delete</button>
                            `;
                        }
                    }
                ],
                order: [[0, 'asc']],
                pageLength: 25
            });

            // Load data from localStorage if available
            const savedRankings = localStorage.getItem('rankings');
            if (savedRankings) {
                rankings = JSON.parse(savedRankings);
                updateTable();
            }
        });

        function updateTable() {
            table.clear();
            table.rows.add(rankings);
            table.draw();
            updateOutput();
            localStorage.setItem('rankings', JSON.stringify(rankings));
        }

        function updateOutput() {
            const output = rankings
                .sort((a, b) => a.ranking - b.ranking)
                .map(r => {
                    const utaiteLink = r.utaiteDisplay ? 
                        `[[${r.utaiteWiki}|${r.utaiteDisplay}]]` : 
                        `[[${r.utaiteWiki}]]`;
                    return `{{FUCE|${r.ranking}|${r.songTitle}|${utaiteLink}|${r.videoId}}}`;
                })
                .join('\n');
            $('#outputText').val(output);
        }

        // All other functions remain the same
        function exportData() {
            const dataStr = JSON.stringify(rankings, null, 2);
            const blob = new Blob([dataStr], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'utacolle_rankings.txt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            toastr.success('Data exported successfully');
        }

        function openImportModal() {
            $('#importModal').removeClass('hidden');
        }

        function closeImportModal() {
            $('#importModal').addClass('hidden');
            $('#importData').val('');
        }

        function importData() {
            try {
                const importedData = JSON.parse($('#importData').val());
                if (Array.isArray(importedData)) {
                    rankings = importedData;
                    updateTable();
                    closeImportModal();
                    toastr.success('Data imported successfully');
                } else {
                    toastr.error('Invalid data format');
                }
            } catch (e) {
                toastr.error('Invalid JSON format');
            }
        }

        function openAddModal() {
            $('#modalTitle').text('Add New Entry');
            $('#editId').val('');
            $('#rankingInput').val(rankings.length + 1);
            $('#songTitleInput').val('');
            $('#utaiteWikiInput').val('');
            $('#utaiteDisplayInput').val('');
            $('#videoIdInput').val('');
            $('#entryModal').removeClass('hidden');
        }

        function openEditModal(ranking) {
            const entry = rankings.find(r => r.ranking === ranking);
            if (entry) {
                $('#modalTitle').text('Edit Entry');
                $('#editId').val(ranking);
                $('#rankingInput').val(entry.ranking);
                $('#songTitleInput').val(entry.songTitle);
                $('#utaiteWikiInput').val(entry.utaiteWiki);
                $('#utaiteDisplayInput').val(entry.utaiteDisplay);
                $('#videoIdInput').val(entry.videoId);
                $('#entryModal').removeClass('hidden');
            }
        }

        function closeModal() {
            $('#entryModal').addClass('hidden');
        }

        function saveEntry() {
            const ranking = parseInt($('#rankingInput').val());
            const editId = $('#editId').val();
            const entry = {
                ranking: ranking,
                songTitle: $('#songTitleInput').val(),
                utaiteWiki: $('#utaiteWikiInput').val(),
                utaiteDisplay: $('#utaiteDisplayInput').val().trim(),
                videoId: $('#videoIdInput').val()
            };

            if (editId) {
                const index = rankings.findIndex(r => r.ranking === parseInt(editId));
                if (index !== -1) {
                    rankings[index] = entry;
                }
            } else {
                rankings.push(entry);
            }

            updateTable();
            closeModal();
            toastr.success('Entry saved successfully');
        }

        function openDeleteModal(ranking) {
            deleteId = ranking;
            $('#deleteModal').removeClass('hidden');
        }

        function closeDeleteModal() {
            deleteId = null;
            $('#deleteModal').addClass('hidden');
        }

        function confirmDelete() {
            if (deleteId !== null) {
                rankings = rankings.filter(r => r.ranking !== deleteId);
                updateTable();
                closeDeleteModal();
                toastr.success('Entry deleted successfully');
            }
        }

        function copyOutput() {
            const outputText = $('#outputText');
            outputText.select();
            document.execCommand('copy');
            toastr.success('Output copied to clipboard');
        }
    </script>
</body>
</html>
